<form class="form-horizontal" id="detailform" method="get" action="">
{% csrf_token %}
    <div class="row">
        <div class="col-lg-12 form-group">
            <label class="col-sm-3 control-label" for="detail_chartofaccount">Chart of Account</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" data-getunit="1" required style="width: 100%" id="detail_chartofaccount" name="detail_chartofaccount"></select>
            </div>
            <span class="help-block form-error"></span>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_bankaccount">
            <label class="col-sm-3 control-label" for="id_detail_bankaccount">Bank Account</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_bankaccount" name="detail_bankaccount">
                <option value="">-- Select Bank Account --</option>
                {% for bankaccount in bankaccount %}
                    <option value="{{ bankaccount.id }}">{{ bankaccount.accountnumber }} - {{ bankaccount.code }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_department">
            <label class="col-sm-3 control-label" for="id_detail_department">Department</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" style="width: 100%" id="detail_department" name="detail_department"></select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_employee">
            <label class="col-sm-3 control-label" for="id_detail_employee">Employee</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" style="width: 100%" id="detail_employee" name="detail_employee"></select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_supplier">
            <label class="col-sm-3 control-label" for="id_detail_supplier">Supplier</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" style="width: 100%" id="detail_supplier" name="detail_supplier"></select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_customer">
            <label class="col-sm-3 control-label" for="id_detail_customer">Customer</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" style="width: 100%" id="detail_customer" name="detail_customer"></select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_unit">
            <label class="col-sm-3 control-label" for="id_detail_unit">Unit</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_unit" name="detail_unit">
                    <option value="">-- Select Unit --</option>
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_branch">
            <label class="col-sm-3 control-label" for="id_detail_branch">Branch</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_branch" name="detail_branch">
                <option value="">-- Select Branch --</option>
                {% for branch in branch %}
                    <option value="{{ branch.id }}">{{ branch.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_product">
            <label class="col-sm-3 control-label" for="id_detail_product">Product</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_product" name="detail_product">
                <option value="">-- Select Product --</option>
                {% for product in product %}
                    <option value="{{ product.id }}">{{ product.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_inputvat">
            <label class="col-sm-3 control-label" for="id_detail_inputvat">Input VAT</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_inputvat" name="detail_inputvat">
                <option value="">-- Select Input VAT --</option>
                {% for inputvat in inputvat %}
                    <option value="{{ inputvat.id }}">{{ inputvat.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_outputvat">
            <label class="col-sm-3 control-label" for="id_detail_outputvat">Output VAT</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_outputvat" name="detail_outputvat">
                <option value="">-- Select Output VAT --</option>
                {% for outputvat in outputvat %}
                    <option value="{{ outputvat.id }}">{{ outputvat.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_vat">
            <label class="col-sm-3 control-label" for="id_detail_vat">VAT</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_vat" name="detail_vat">
                <option value="">-- Select VAT --</option>
                {% for vat in vat %}
                    <option value="{{ vat.id }}">{{ vat.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_wtax">
            <label class="col-sm-3 control-label" for="id_detail_wtax">WTAX</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_wtax" name="detail_wtax">
                <option value="">-- Select WTAX --</option>
                {% for wtax in wtax %}
                    <option value="{{ wtax.id }}">{{ wtax.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_ataxcode">
            <label class="col-sm-3 control-label" for="id_detail_ataxcode">ATAX Code</label>
            <div class="col-sm-9">
                <select class="form-control input-sm" id="detail_ataxcode" name="detail_ataxcode">
                <option value="">-- Select ATAX Code --</option>
                {% for ataxcode in ataxcode %}
                    <option value="{{ ataxcode.id }}">{{ ataxcode.code }} - ({{ ataxcode.rate }}%) - {{ ataxcode.description }}</option>
                {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_reftype">
            <label class="col-sm-3 control-label" for="id_detail_reftype">Ref. Type</label>
            <div class="col-sm-9">
                <input type="text" class="form-control input-sm" id="detail_reftype" name="detail_reftype">
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_refnum">
            <label class="col-sm-3 control-label" for="id_detail_refnum">Ref. Num.</label>
            <div class="col-sm-9">
                <input type="text" class="form-control input-sm" id="detail_refnum" name="detail_refnum">
            </div>
        </div>
        <div class="col-lg-12 form-group hide" id="v_detail_refdate">
            <label class="col-sm-3 control-label" for="id_detail_refdate">Ref. Date</label>
            <div class="col-sm-9">
                <input type="text" class="form-control input-sm date-yyyymmdd datepicker week" readonly="readonly"
                       style="padding: 5px 10px" id="detail_refdate" name="detail_refdate" placeholder="YYYY-MM-DD">
            </div>
        </div>
        <div class="col-lg-12 form-group">
            <div class="col-lg-6">
                <label class="col-sm-6 control-label" for="detail_debitamount">Debit Amount</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control input-sm text-right amount" name="detail_debitamount" id="detail_debitamount" placeholder="0.00" value="0.00">
                </div>
            </div>
            <div class="col-lg-6">
                <label class="col-sm-6 control-label" for="detail_creditamount">Credit Amount</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control input-sm text-right amount" name="detail_creditamount" id="detail_creditamount" placeholder="0.00" value="0.00">
                </div>
            </div>
        </div>
        <div class="col-sm-12 pull-left margin-bottom-10 margin-top-20">
            <button type="button" class="btn btn-round btn-dark waves-effect waves-light btndadd" id="btn_detailsubmit">Add Accounting Entry</button>
            <button type="button" class="btn btn-round btn-dark waves-effect waves-light btndadd" id="btn_detailclose">Close</button>
            <input type="hidden" name="updatedatailid" id="updatedatailid">
            <button type="button" class="btn btn-round btn-success waves-effect waves-light btndupdate" style="display: none" id="btn_updatedetailsubmit">Update Entry</button>
            <button type="button" class="btn btn-round btn-danger waves-effect waves-light btndupdate" style="display: none" id="btn_detailcancel">Close Entry</button>
        </div>
    </div>
</form>
<script type="text/javascript">
    $(document).ready(function() {
        $('.select2modal').select2({});

        //Ajax Form Search
        ajaxselect2("chartofaccount_posting", "detail_chartofaccount");
        ajaxselect2("department", "detail_department");
        ajaxselect2("employee", "detail_employee");
        ajaxselect2("supplier", "detail_supplier");
        ajaxselect2("customer", "detail_customer");

        $("#manualbutton").click(function(){
            $("#entryview").show();
        });
        $("#btn_detailclose").click(function(){
            $("#entryview").hide();
        });
        $("#detailform").validate({
            errorPlacement: function(error, element) {
            $( element )
				.closest( "form" )
					.find( "span[for='" + element.attr( "id" ) + "']" )
						.append( error );
            },
            errorElement: "span",
        });

        $("#btn_detailsubmit").click(function() {
            var m_debitamount = $('#detail_debitamount').val();
	        var m_creditamount = $('#detail_creditamount').val();
	        var department = $('#detail_department').val();
            if ($("#detailform").valid()) {

                if ((m_debitamount == 0 || m_debitamount == "" ) && (m_creditamount == 0 || m_creditamount == "")) {
                    alert('Debit and Credit amount must not be zero');
                    return false;
                }

                if ((m_debitamount != "" && m_creditamount == 0) || (m_debitamount == 0  && m_creditamount != "")) {
                    alert('Accounting Entry Submitted');
                } else if ((m_debitamount != "" && m_creditamount != "")) {
                    alert('Choose only one Debit and Credit amount');
                    return false;
                }

                $.ajax({
                    url: "{% url 'acctentry:savemaccountingentry' %}",
                    type: "post",
                    data: {'csrfmiddlewaretoken': "{{csrf_token}}",
                           'secretkey': $("#secretkey").val(),
                           'table': "{{ table }}",
                           'chartofaccount': $("#detail_chartofaccount").val(),
                           'bankaccount': $("#detail_bankaccount").val(),
                           'department': $("#detail_department").val(),
                           'employee': $("#detail_employee").val(),
                           'supplier': $("#detail_supplier").val(),
                           'customer': $("#detail_customer").val(),
                           'unit': $("#detail_unit").val(),
                           'branch': $("#detail_branch").val(),
                           'product': $("#detail_product").val(),
                           'inputvat': $("#detail_inputvat").val(),
                           'outputvat': $("#detail_outputvat").val(),
                           'vat': $("#detail_vat").val(),
                           'wtax': $("#detail_wtax").val(),
                           'ataxcode': $("#detail_ataxcode").val(),
                           'reftype': $("#detail_reftype").val(),
                           'refnum': $("#detail_refnum").val(),
                           'refdate': $("#detail_refdate").val(),
                           'creditamount': $("#detail_creditamount").val(),
                           'debitamount': $("#detail_debitamount").val(),
                    },
                    success: function(response) {

                        if (response["status"] == "error") {
                            alert(response['msg']);
                            return false;
                        } else {
                            $("#datatable").html(response['datatable']);
                        }
                    },
                    error: function(response) {
                        console.log(response);
                    }
                })

            } else {
                alert('Please fill in the fields.')
            }
        });

        $("#detail_chartofaccount").change(function(x) {

            id = $("#detail_chartofaccount").val();
            unitid = $("#detail_chartofaccount").data('getunit');
            chartofaccount.validate(id, unitid);
        });

        $('#btn_updatedetailsubmit').on('click', function() {
            var m_debitamount = $('#detail_debitamount').val();
	        var m_creditamount = $('#detail_creditamount').val();
            if ($("#detailform").valid()) {

                if ((m_debitamount == 0 || m_debitamount == "" ) && (m_creditamount == 0 || m_creditamount == "")) {
                    alert('Debit and Credit amount must not be zero');
                    return false;
                }

                if ((m_debitamount != "" && m_creditamount == 0) || (m_debitamount == 0  && m_creditamount != "")) {
                    alert('Accounting Entry Submitted');
                } else if ((m_debitamount != "" && m_creditamount != "")) {
                    alert('Choose only one Debit and Credit amount');
                    return false;
                }

                var id = $('#updatedatailid').val();

                $.ajax({
                    url: "{% url 'acctentry:saveupdatemaccountingentry' %}",
                    type: "post",
                    data: {'csrfmiddlewaretoken': "{{csrf_token}}",
                           'id': id,
                           'secretkey': $("#secretkey").val(),
                           'table': '{{ table }}',
                           'chartofaccount': $("#detail_chartofaccount").val(),
                           'bankaccount': $("#detail_bankaccount").val(),
                           'department': $("#detail_department").val(),
                           'employee': $("#detail_employee").val(),
                           'employeetype': $("#detail_employee option:selected").data('type'),
                           'supplier': $("#detail_supplier").val(),
                           'suppliertype': $("#detail_supplier option:selected").data('type'),
                           'customer': $("#detail_customer").val(),
                           'customertype': $("#detail_customer option:selected").data('type'),
                           'unit': $("#detail_unit").val(),
                           'branch': $("#detail_branch").val(),
                           'product': $("#detail_product").val(),
                           'inputvat': $("#detail_inputvat").val(),
                           'outputvat': $("#detail_outputvat").val(),
                           'vat': $("#detail_vat").val(),
                           'wtax': $("#detail_wtax").val(),
                           'ataxcode': $("#detail_ataxcode").val(),
                           'reftype': $("#detail_reftype").val(),
                           'refnum': $("#detail_refnum").val(),
                           'refdate': $("#detail_refdate").val(),
                           'creditamount': $("#detail_creditamount").val(),
                           'debitamount': $("#detail_debitamount").val(),
                    },
                    success: function(response) {
                        $("#datatable").html(response['datatable']);
                    },
                    error: function(response) {
                        console.log(response);
                    }
                })

            } else {
                alert('Please fill in the fields.')
            }
        });

        $('#datatable').unbind().on('click', '.detailedit', function () {
            $("#detail_unit").empty();

            var chartid = $(this).data('chartid');
            chartofaccount.validate(chartid, 2);

            var id = $(this).data('id');
            $("#updatedatailid").val(id);

            $('.trd_data').css("background-color","");
            $("#trd_data_"+id).css('background-color', '#f2dede');
            $("#btn_updatedetailbsubmit").attr('data-id', id);
            $("#entryview").show();
            $('.btndadd').hide();
            $('.btndupdate').show();
            $.ajax({
                url: "{% url 'acctentry:updateentry' %}",
                type: "post",
                data: {'csrfmiddlewaretoken': "{{csrf_token}}",
                       'secretkey': $("#secretkey").val(),
                       'table': "{{ table }}",
                       'id': id,
                       'chartid': chartid
                },
                success: function(response) {
                    var info = $.parseJSON(response.info);

                    $("#detail_chartofaccount").html("<option value='"+info[0].chartofaccount+"'>["+info[0].chartofaccount_accountcode+"] - "+info[0].chartofaccount_title+"</option>");
                    $("#detail_chartofaccount").attr('getunit', 2).trigger('change').attr('disabled','disabled');

                    $("#detail_department").html("<option value='"+info[0].department+"'>"+info[0].department_departmentname+"</option>").trigger('change');
                    if (info[0].employeebreakstatus == 1 || info[0].employeebreakstatus == 2) {
                        $("#detail_employee").html("<option value='"+info[0].employee+"'>"+info[0].employee_code+" - "+info[0].employee_lastname+", "+info[0].employee_firstname+" "+info[0].employee_middlename+"</option>");
                        $("#detail_employee option").attr('disabled', 'disabled');
                        $("#detail_employee option:selected").removeAttr('disabled').attr('data-type','Y');
                        alert('Employee cannot be edited because of breakdown entry!');
                    } else {
                        $("#detail_employee").html("<option value='"+info[0].employee+"'>"+info[0].employee_code+" - "+info[0].employee_lastname+", "+info[0].employee_firstname+" "+info[0].employee_middlename+"</option>");
                    }
                    if (info[0].supplierbreakstatus == 1 || info[0].supplierbreakstatus == 2) {
                        $("#detail_supplier").html("<option value='"+info[0].supplier+"'>"+info[0].supplier_name+"</option>");
                        $("#detail_supplier option").attr('disabled', 'disabled');
                        $("#detail_supplier option:selected").removeAttr('disabled').attr('data-type','Y');
                        alert('Supplier cannot be edited because of breakdown entry!');
                    } else {
                        $("#detail_supplier").html("<option value='"+info[0].supplier+"'>"+info[0].supplier_name+"</option>");
                    }
                    if (info[0].customerbreakstatus == 1 || info[0].customerbreakstatus == 2) {
                        $("#detail_customer").html("<option value='"+info[0].customer+"'>"+info[0].customer_name+"</option>");
                        $("#detail_customer option").attr('disabled', 'disabled');
                        $("#detail_customer option:selected").removeAttr('disabled').attr('data-type','Y');
                        alert('Customer cannot be edited because of breakdown entry!');
                    } else {
                        $("#detail_customer").html("<option value='"+info[0].customer+"'>"+info[0].customer_name+"</option>");
                    }

                    $("#detail_bankaccount").val(info[0].bankaccount);
                    $("#detail_branch").val(info[0].branch);
                    $("#detail_product").val(info[0].product);
                    $("#detail_inputvat").val(info[0].inputvat);
                    $("#detail_outputvat").val(info[0].outputvat);
                    $("#detail_vat").val(info[0].vat);
                    $("#detail_wtax").val(info[0].wtax);
                    $("#detail_ataxcode").val(info[0].ataxcode);
                    $("#detail_reftype").val(info[0].reftype);
                    $("#detail_refnum").val(info[0].refnum);
                    $("#detail_refdate").val(info[0].refdate);
                    $("#detail_creditamount").val(info[0].creditamountformatted);
                    $("#detail_debitamount").val(info[0].debitamountformatted);

                    unit = response.unit;
                    unitlist = $.parseJSON(unit);

                    var unitoptions = '<option value="">-- Select Unit --</option>';
                    $.each(unitlist, function (k, v) {
                        if (v.pk == info[0].unit){
                        unitoptions += '<option selected="selected" value="' + v.pk + '">' + v.fields.description + '</option>';
                        } else {
                        unitoptions += '<option value="' + v.pk + '">' + v.fields.description + '</option>';
                        }
                    });
                    $("#detail_unit").prepend(unitoptions);

                    $("#detail_chartofaccount").focus();
                },
                error: function(response) {
                    console.log(response);
                }
            });
        });

        /* Chart of Account functions */
        var chartofaccount = (function() {
            // your module code goes here
            return {
                validate:function(id, unitselect) {
                    $("#v_detail_bankaccount").addClass('hide');
                    $("#detail_bankaccount").removeAttr('required');
                    $("#detail_bankaccount").prop("selectedIndex", 0);
                    $("#v_detail_department").addClass('hide');
                    $("#detail_department").removeAttr('required');
                    $("#detail_department").select2("val",0);
                    $("#detail_department").html("");
                    $("#v_detail_employee").addClass('hide');
                    $("#detail_employee").removeAttr('required');
                    $("#detail_employee").prop("selectedIndex", 0);
                    $("#detail_employee").html("");
                    $("#v_detail_supplier").addClass('hide');
                    $("#detail_supplier").removeAttr('required');
                    $("#detail_supplier").prop("selectedIndex", 0);
                    $("#detail_supplier").html("");
                    $("#v_detail_customer").addClass('hide');
                    $("#detail_customer").removeAttr('required');
                    $("#detail_customer").prop("selectedIndex", 0);
                    $("#detail_customer").html("");
                    $("#v_detail_unit").addClass('hide');
                    $("#detail_unit").removeAttr('required');
                    $("#detail_unit").prop("selectedIndex", 0);
                    $("#v_detail_branch").addClass('hide');
                    $("#detail_branch").removeAttr('required');
                    $("#detail_branch").prop("selectedIndex", 0);
                    $("#v_detail_product").addClass('hide');
                    $("#detail_product").removeAttr('required');
                    $("#detail_product").prop("selectedIndex", 0);
                    $("#v_detail_inputvat").addClass('hide');
                    $("#detail_inputvat").removeAttr('required');
                    $("#detail_inputvat").prop("selectedIndex", 0);
                    $("#v_detail_outputvat").addClass('hide');
                    $("#detail_outputvat").removeAttr('required');
                    $("#detail_outputvat").prop("selectedIndex", 0);
                    $("#v_detail_vat").addClass('hide');
                    $("#detail_vat").removeAttr('required');
                    $("#detail_vat").prop("selectedIndex", 0);
                    $("#v_detail_wtax").addClass('hide');
                    $("#detail_wtax").removeAttr('required');
                    $("#detail_wtax").prop("selectedIndex", 0);
                    $("#v_detail_ataxcode").addClass('hide');
                    $("#detail_ataxcode").removeAttr('required');
                    $("#detail_ataxcode").prop("selectedIndex", 0);
                    $("#v_detail_reftype").addClass('hide');
                    $("#detail_reftype").removeAttr('required');
                    $("#detail_reftype").val('');
                    $("#v_detail_refnum").addClass('hide');
                    $("#detail_refnum").removeAttr('required');
                    $("#detail_refnum").val('');
                    $("#v_detail_refdate").addClass('hide');
                    $("#detail_refdate").removeAttr('required');
                    $("#detail_refdate").val('');
                    $("#detail_creditamount").val("0.00");
                    $("#detail_debitamount").val("0.00");

                    $("#detail_employee option").removeAttr('disabled');
                    $("#detail_supplier option").removeAttr('disabled');
                    $("#detail_customer option").removeAttr('disabled');

                    if (id != "") {
                        $.ajax({
                            url: "{% url 'acctentry:checkchartvalidation' %}",
                            type: "post",
                            dataType: "json",
                            data: {
                                'csrfmiddlewaretoken': "{{csrf_token}}",
                                'chartid':  id
                            },
                            success: function(response){
                                chart = response.chart;
                                chartdata = $.parseJSON(chart);
                                //console.log(chartdata[0].fields['bankaccount_enable']);
                                if (chartdata[0].fields['bankaccount_enable'] == 'Y') {
                                    $("#v_detail_bankaccount").removeClass('hide');
                                    $("#detail_bankaccount").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['department_enable']);
                                if (chartdata[0].fields['department_enable'] == 'Y') {
                                    $("#v_detail_department").removeClass('hide');
                                    $("#detail_department").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['employee_enable']);
                                if (chartdata[0].fields['employee_enable'] == 'Y') {
                                    $("#v_detail_employee").removeClass('hide');
                                    $("#detail_employee").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['supplier_enable']);
                                if (chartdata[0].fields['supplier_enable'] == 'Y') {
                                    $("#v_detail_supplier").removeClass('hide');
                                    $("#detail_supplier").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['customer_enable']);
                                if (chartdata[0].fields['customer_enable'] == 'Y') {
                                    $("#v_detail_customer").removeClass('hide');
                                    $("#detail_customer").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['unit_enable']);
                                if (chartdata[0].fields['unit_enable'] == 'Y') {
                                    $("#v_detail_unit").removeClass('hide');
                                    $("#detail_unit").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['branch_enable']);
                                if (chartdata[0].fields['branch_enable'] == 'Y') {
                                    $("#v_detail_branch").removeClass('hide');
                                    $("#detail_branch").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['product_enable']);
                                if (chartdata[0].fields['product_enable'] == 'Y') {
                                    $("#v_detail_product").removeClass('hide');
                                    $("#detail_product").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['inputvat_enable']);
                                if (chartdata[0].fields['inputvat_enable'] == 'Y') {
                                    $("#v_detail_inputvat").removeClass('hide');
                                    $("#detail_inputvat").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['outputvat_enable']);
                                if (chartdata[0].fields['outputvat_enable'] == 'Y') {
                                    $("#v_detail_outputvat").removeClass('hide');
                                    $("#detail_outputvat").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['vat_enable']);
                                if (chartdata[0].fields['vat_enable'] == 'Y') {
                                    $("#v_detail_vat").removeClass('hide');
                                    $("#detail_vat").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['wtax_enable']);
                                if (chartdata[0].fields['wtax_enable'] == 'Y') {
                                    $("#v_detail_wtax").removeClass('hide');
                                    $("#detail_wtax").attr('required', 'required');
                                }
                                //console.log(chartdata[0].fields['ataxcode_enable']);
                                if (chartdata[0].fields['ataxcode_enable'] == 'Y') {
                                    $("#v_detail_ataxcode").removeClass('hide');
                                    $("#detail_ataxcode").attr('required', 'required');
                                }

                                if (window.location.pathname.match("^/debitcreditmemo/")){
                                    if (chartdata[0].fields['reftype_enable'] == 'Y') {
                                        $("#v_detail_reftype").removeClass('hide');
                                        $("#detail_reftype").attr('required', 'required');
                                    }
                                    if (chartdata[0].fields['refnum_enable'] == 'Y') {
                                        $("#v_detail_refnum").removeClass('hide');
                                        $("#detail_refnum").attr('required', 'required');
                                    }
                                    if (chartdata[0].fields['refdate_enable'] == 'Y') {
                                        $("#v_detail_refdate").removeClass('hide');
                                        $("#detail_refdate").attr('required', 'required');
                                    }
                                }


                                if (unitselect == 1) {
                                    unit = response.unit;
                                    unitlist = $.parseJSON(unit);

                                    $("#detail_unit").empty();
                                    var unitoptions = '<option value="">-- Select Unit --</option>';
                                    $.each(unitlist, function (k, v) {
                                        unitoptions += '<option value="' + v.pk + '">' + v.fields.description + '</option>';
                                    });
                                    $("#detail_unit").prepend(unitoptions);
                                    //$("#detail_unit option:first").attr('selected', 'selected');
                                    //$("#detail_unit").attr('disabled', false);
                                }

                            }, error: function(response) {
                                console.debug(response);
                            }
                        });
                    }
                }
            }
        }());

        $('#btn_detailcancel').click(function(){
            $('.trd_data').css("background-color","");
            $('.btndadd').show();
            $('.btndupdate').hide();

            $("#btn_updatedetailbsubmit").attr('data-id', 0);
            $("#detail_chartofaccount").val("").trigger('change');
            $("#detail_chartofaccount").removeAttr('disabled');
            $("#detail_bankaccount").val("");
            $("#detail_department").val("");
            $("#detail_employee").val("");
            $("#detail_supplier").val("");
            $("#detail_customer").val("");
            $("#detail_unit").val("");
            $("#detail_branch").val("");
            $("#detail_productt").val("");
            $("#detail_inputvat").val("");
            $("#detail_outputvat").val("");
            $("#detail_vat").val("");
            $("#detail_wtax").val("");
            $("#detail_ataxcode").val("");
            $("#detail_reftype").val("");
            $("#detail_refnum").val("");
            $("#detail_refdate").val("");
            $("#detail_creditamount").val("0.00");
            $("#detail_debitamount").val("0.00");
        });

        $('#btnclosebreakdown').unbind().on('click', function () {
            var detailamount = $('#detailb_amount').val();
            var balancecode = $('#detailb_amount').data('balancecode');
            var detailid = $('#detailb_amount').data('detailid');
            var datatype = $('#detailb_amount').data('type');

            var totalbreakdown_creditamount = $('#totalbreakdown_creditamount').text();
            var totalbreakdown_debitamount = $('#totalbreakdown_debitamount').text();

            var amout = 0;
            var amountdetail = 0;
            var creditamount = totalbreakdown_creditamount.replace(',', '');
            var debitamount = totalbreakdown_debitamount.replace(',', '');

            amount = parseFloat(debitamount) - parseFloat(creditamount);

            //console.log(amount);
            if (balancecode == 'D') {
                amountdetail = parseFloat(detailamount)*1;
            } else {
                amountdetail = parseFloat(detailamount)*-1;
            }

            var stat = 0;
            if (parseFloat(amountdetail) != parseFloat(amount)) {
                var amount = parseFloat(amountdetail) - parseFloat(amount);
                //console.log('#tdtarget_'+datatype+''+detailid);
                alert('Account does not tally with total balance!. Amount differ by '+amount.toFixed(2));
                stat = 1;
                $('#tdtarget_'+datatype+''+detailid).addClass('unbalancebreakdown').css('background-color', '#f2dede');
            } else {
                //console.log('equal');
                stat = 2;
                $('#tdtarget_'+datatype+''+detailid).removeClass('unbalancebreakdown').css('background-color', '');
            }

            $.ajax({
                url: "{% url 'acctentry:updatebreakdownstatus' %}",
                type: "post",
                data: {'detailid': detailid, 'datatype': datatype, 'table': '{{ table }}', 'stat': stat},
                success: function(response) {
                    console.log(response);
                },
                error: function(response) {
                    console.log(response);
                }
            });

            $('#modal-row').modal('toggle');
        });

    });
</script>
<style>
    #datatable{
        font-size: 13px;
    }
    #breaktabledata, #datatablebreakdown{
        font-size: 12px;
    }
    #datatable td, #datatablebreakdown td{
        padding: 8px;
    }
    table#breaktabledata>tbody>tr>td{
        border: none;
        height: 30px;
        padding: 21px;
        padding-top: 12px;
        padding-bottom: 12px;
    }
    .actionrow{
        text-align: right;
        background-color: white;
        border: 2px solid white !important;
        border-left: 1px solid #e0e0e0 !important;
    }
</style>
{% block extra_js %}
    {% load static %}
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/custom-datepicker.js' %}"></script>
    <script src="{% static 'js/jquery.maskMoney.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom-maskMoney.js' %}" type="text/javascript"></script>
{% endblock extra_js %}