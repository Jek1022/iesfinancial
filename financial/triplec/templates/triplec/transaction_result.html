{% load humanize %}
{% load mathfilters %}
{% load custom %}
{% load staticfiles %}
{% load custom_tags %}
<meta http-equiv="Content-type" content="text/html; charset=utf-8" /> 
<br>
<link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}" />
{% block extra_css %}
    <style>
        input[type=search]::-webkit-search-cancel-button {
            -webkit-appearance: searchfield-cancel-button;
        }
        .pointer {
            cursor: pointer;
        }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    
        input[type=number], 
        .amount-right{
            text-align: right;
        }

        td {
            font-weight: bold;
        }
        
    </style>
{% endblock extra_css %}

<div class="col-md-12 col-sm-12 col-xs-12" id="triplec_result">
    <div class="row">
        <div class="col-md-12">
            <div class="col-md-6"></div>
            <div class="col-md-6">
                <div class="col-sm-3"></div>
                <div class="col-sm-3">
                    
                </div>
                <div class="col-sm-3"></div>
                <div class="col-sm-3 text-right" title="Full screen">
                    <i class="fa fa-arrows-alt pointer" aria-hidden="true" id="full_screen"></i>
                </div>
            </div>
        </div>
    </div>
    {% if triplec_data %}
    <div class="page-wrap">
        <h3>THE PHILIPPINE DAILY INQUIRER, INC.</h3>
        <h4>TRIPLE-C TRANSACTION LISTING </h4>
        <h4 style="text-transform:uppercase">AS OF {{ dfrom }} to {{ dto }}</h4>
        <br>
        <div class="row">
            
            <div class="col-md-12">
                <div class="row">
                    <div class="col-sm-8">
                        <button class="btn btn-default waves-effect waves-dark" id="batch_tagging" disabled title="Batch tagging of Class and Author Name" data-toggle="modal" data-target="#batchTagging">
                            <i class="fa fa-tags" aria-hidden="true"></i>&nbsp;&nbsp;Batch Tagging
                        </button>
                        <!-- <button class="btn btn-default waves-effect waves-dark" id="batch_transaction_entry" disabled title="Selected rows with saved Class and Author Name will be included in transaction entry." data-toggle="modal" data-target="#batchTransactionEntry">
                            <i class="fa fa-clipboard" aria-hidden="true"></i>&nbsp;&nbsp;Batch Transaction Entry
                        </button> -->
                        <!-- <button class="btn btn-default waves-effect waves-dark" id="batch_transaction_process" disabled title="Selected rows with saved Type and Author Name will be included in transaction entry.">
                            <i class="fa fa-clipboard" aria-hidden="true"></i>&nbsp;&nbsp;Batch Transaction Process
                        </button> -->
                        <button class="btn btn-default waves-effect waves-dark" id="batch_save" disabled title="Selected rows with Class and Author Name will be saved.">
                            <i class="fa fa-save" aria-hidden="true"></i>&nbsp;&nbsp;Batch Save
                        </button>
                        <button class="btn btn-default waves-effect waves-dark" id="batch_print" disabled title="Selected and posted transactions will be included for printing.">
                            <i class="fa fa-print" aria-hidden="true"></i>&nbsp;&nbsp;Batch Print
                        </button>
                        <button class="btn btn-default waves-effect waves-dark" id="post_ap" disabled title="Selected and posted transactions will be included for AP posting." data-toggle="modal" data-target="#postAP">
                            <i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp;&nbsp;Post to AP
                        </button>
                        <!-- <button class="btn btn-default waves-effect waves-dark" id="batch_clear" disabled title="Selected rows with Type and Author Name will be cleared.">
                            <i class="fa fa-minus-square-o" aria-hidden="true"></i>&nbsp;&nbsp;Clear
                        </button> -->
                        <!-- <button class="btn btn-default waves-effect waves-dark" id="unselect" disabled title="Unselect all the selected rows.">
                            <i class="fa fa-square-o" aria-hidden="true"></i>&nbsp;&nbsp;Unselect
                        </button> -->
                    </div>
                    <div class="col-sm-2 text-left">
                        <a style="display: none;" href="" id="trigger_cs" target="_blank">CS</a>
                    </div>
                </div>
            </div>
        </div>
        <br>
       
        <div class="row">
            <div class="col-md-12" style="min-height: 500px; max-height: 900px; overflow: auto;">
                <table class="table table-striped" id="triplec_table">
                    <thead style="position: sticky; top: 0; z-index: 1; background: ghostwhite; border: none;">
                        <tr class="border-0" id="triplec_table_header">
                            <th style="color:#424242">#</th>
                            <th style="color:#424242"><input type="checkbox" class="pointer" name="chb_all" id="chb_all" /></th>
                            <th style="color:#424242">Issue Date</th>
                            <th style="color:#424242">Publication</th>
                            <th style="color:#424242">Bureau</th>
                            <th style="color:#424242">Section</th>
                            <th style="color:#424242">Page</th>
                            <th style="color:#424242">Article Title</th>
                            <th style="color:#424242">Byline</th>
                            <th style="color:#424242">Code</th>
                            <th style="color:#424242">Author Name</th>
                            <th style="color:#424242">Classification</th>
                            <th style="color:#424242">Type</th>
                            <th style="color:#424242">Created by</th>
                            <th style="color:#424242">No. of Words</th>
                            <th style="color:#424242">No. of Characters</th>
                            <th style="color:#424242">CS No.</th>
                            <th style="color:#424242">Status</th>
                            <th style="color:#424242">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% autoescape off %}

                        {% classifications_to_options_html classifications as classifications_options_html %}
                        {% author_codes_to_options_html authors as author_codes_options_html %}
                        {% author_names_to_options_html authors as author_names_options_html %}

                        {% for data in triplec_data %}
                            <tr>
                                <td class="c0"></td>
                                <td class="c1">
                                    <input type="hidden" name="data_id" value="{{ data.id }}" />
                                    <input type="hidden" name="data_subtype_id" value="{{ data.subtype_id|default:'' }}" />
                                    <input type="hidden" name="data_bureau_id" value="{{ data.bureau_id|default:'' }}" />
                                    <input type="hidden" name="data_section_id" value="{{ data.section_id|default:'' }}" />
                                    <input type="hidden" name="data_status" value="{{ data.status }}" />
                                    <input type="hidden" name="data_status_txt" value="{{ data.get_status_display }}" />
                                    <input type="hidden" name="data_rate_code" value="{{ data.rate_code|default:'' }}" />
                                    <input type="hidden" name="data_amount" value="{{ data.amount }}" />
                                    <input type="hidden" name="data_no_of_ccc" value="{{ data.no_of_ccc }}" />
                                    <input type="hidden" name="data_no_of_items" value="{{ data.no_items|default:'' }}" />
                                    <input type="hidden" name="data_length1" value="{{ data.length1 }}" />
                                    <input type="hidden" name="data_length2" value="{{ data.length2 }}" />
                                    <input type="hidden" name="data_length3" value="{{ data.length3 }}" />
                                    <input type="hidden" name="data_length1" value="{{ data.length1 }}" />
                                    <input type="hidden" name="data_width1" value="{{ data.width1 }}" />
                                    <input type="hidden" name="data_width2" value="{{ data.width2 }}" />
                                    <input type="hidden" name="data_width3" value="{{ data.width3 }}" />
                                    <input type="hidden" name="data_width4" value="{{ data.width4 }}" />
                                    <input type="hidden" name="data_total_size" value="{{ data.total_size }}" />
                                    <input type="hidden" name="data_confirmation" value="{{ data.confirmation }}" />
                                    <input type="hidden" name="data_apv_no" value="{{ data.apv_no }}" />
                                    <input type="hidden" name="data_apv_date" value="{{ data.date_apv }}" />
                                    <input type="checkbox" class="triplec-checkbox pointer" name="chb_{{ data.id }}" id="chb_{{ data.id }}" />
                                </td>

                                <!-- ready for posting and posted entries -->
                                {% if data.status in 'EO' %}

                                    <td class="c2">{{ data.issue_date|date:'Y-m-d' }}</td>
                                    <td class="c3">{{ data.cms_publication }}</td>
                                    <td class="c14">{{ data.bureau.description|default:"" }}</td>
                                    <td class="c4">{{ data.section.description }}</td>
                                    <td class="c5">{{ data.page.description }}</td>
                                    <td class="c6">{{ data.article_title }}</td>
                                    <td class="c7">{{ data.cms_byline|default:"" }}</td>
                                    <td class="c8">
                                        <select class="form-control input-sm select2" style="width: 110px;" name="code">
                                            {% if data.code %}
                                                {% author_codes_to_html authors data.code as author_codes_html %}
                                                <option value="">-- Select --</option>
                                                {{ author_codes_html }}
                                            {% else %}
                                                {{ author_codes_options_html }}
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td class="c9">
                                        <select class="form-control input-sm select2" style="width: 145px;" name="author_name">
                                            {% if data.author_name %}
                                                {% author_names_to_html authors data.author_name as author_names_html %}
                                                <option value="">-- Select --</option>
                                                {{ author_names_html }}
                                            {% else %}
                                                {{ author_names_options_html }}
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td class="c10">
                                        
                                        <select class="form-control input-sm" style="width: 110px;" name="type">
                                            {% if data.type %}
                                                {% classifications_to_html classifications data.type as classifications_html %}
                                                <option value="">-- Select --</option>
                                                {{ classifications_html }}
                                            {% else %}
                                                {{ classifications_options_html }}
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td class="c15">{{ data.subtype.description|default:"" }}</td>
                                    <td class="c11">{{ data.cms_created_by }}</td>
                                    <td class="c12">{{ data.no_of_words }}</td>
                                    <td class="c13">{{ data.no_of_characters }}</td>
                                    <td class="c17">{{ data.confirmation|default:"" }}</td>
                                    <td class="c16">{{ data.get_status_display }}</td>
                                    <td>
                                        <div style="display:flex; flex-direction: row; justify-content: center; align-items: center; font-size: 24px;">
                                            <div class="row nowrap">
                                                <a class="pointer edit-transaction-entry" title="View or Edit Transaction" data-toggle="modal" data-target="#transactionEntryModal">
                                                    <i class="icon fa-file-text" aria-hidden="true">&nbsp;&nbsp;</i>
                                                </a>
                                                {% if data.status == 'O' %}
                                                    {% if not data.apv_no or data.apv_no == '' %}
                                                        <a class="pointer revert-transaction-entry" title="Revert transaction status as Ready for Posting. Associated data like quota and CS No. will be removed.">
                                                            <i class="icon md-refresh" aria-hidden="true">&nbsp;&nbsp;</i>
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>

                                <!-- active entries -->
                                {% else %}
                                    
                                    <td class="c2">{{ data.cms_issue_date|date:'Y-m-d' }}</td>
                                    <td class="c3">{{ data.cms_publication }}</td>
                                    <td class="c14">{{ data.bureau.description|default:"" }}</td>
                                    <td class="c4">{{ data.section.description|default:"" }}</td>
                                    <td class="c5">{{ data.cms_page }}</td>
                                    <td class="c6">{{ data.cms_article_title|default:"" }}</td>
                                    <td class="c7">{{ data.cms_byline|default:"" }}</td>
                                    <td class="c8">

                                        
                                        <select class="form-control input-sm select2" style="width: 110px;" name="code">
                                            {% if data.code %}
                                                {% author_codes_to_html authors data.code as author_codes_html %}
                                                <option value="">-- Select --</option>
                                                {{ author_codes_html }}
                                            {% else %}
                                                {{ author_codes_options_html }}
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td class="c9">
                                        <select class="form-control input-sm select2" style="width: 145px;" name="author_name">
                                            {% if data.author_name %}
                                                {% author_names_to_html authors data.author_name as author_names_html %}
                                                <option value="">-- Select --</option>
                                                {{ author_names_html }}
                                            {% else %}
                                                {{ author_names_options_html }}
                                            {% endif %}
                                        </select>
                                        
                                    </td>
                                    <td class="c10">

                                        {% classifications_to_html classifications data.type as classifications_html %}
                                        <select class="form-control input-sm" style="width: 110px;" name="type">
                                            <option value="">-- Select --</option>
                                            {{ classifications_html }}
                                        </select>
                                    </td>
                                    <td class="c15">{{ data.subtype.description|default:"" }}</td>
                                    <td class="c11">{{ data.cms_created_by }}</td>
                                    <td class="c12">{{ data.cms_no_of_words }}</td>
                                    <td class="c13">{{ data.cms_no_of_characters }}</td>
                                    <td class="c17">{{ data.confirmation|default:"" }}</td>
                                    <td class="c16">{{ data.get_status_display }}</td>
                                    <td>
                                        <div class="iconlist-wrap auto-0">
                                            <div class="iconlist" style="text-align: center">
                                                <!-- <a href="" class="btnDetail" data-toggle="tooltip" data-placement="left" data-trigger="hover" data-original-title="Click to View" title="" aria-describedby="tooltip850155">
                                                    <i class="icon md-view-list" aria-hidden="true">&nbsp;&nbsp;</i>
                                                </a> -->
                                                {% if not data.author_name or data.author_name == '' or data.author_name == 'None' and not data.code %}
                                                    <a class="hidden pointer edit-transaction-entry" title="View or Edit Transaction" data-toggle="modal" data-target="#transactionEntryModal">
                                                        <i class="icon fa-file-text" aria-hidden="true">&nbsp;&nbsp;</i>
                                                    </a>
                                                {% else %}
                                                    <a class="pointer edit-transaction-entry" title="View or Edit Transaction" data-toggle="modal" data-target="#transactionEntryModal">
                                                        <i class="icon fa-file-text" aria-hidden="true">&nbsp;&nbsp;</i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>

                                {% endif %}
                            </tr>
                        {% endfor %}
                        {% endautoescape %}
                    </tbody>
                </table>
            </div>
        </div>
        <br>
        <br>
        <!-- <div class="row text-center">
            <div class="col-md-12">
                <button class="btn btn-success waves-effect waves-dark" id="save_all" style="margin-top: 22px;"><i class="fa fa-floppy-o" aria-hidden="true"></i> &nbsp;&nbsp;Save All</button>
            </div>
        </div> -->
    </div>
    {% else %}
    <br>
    <br>
    <br>
        <div class="row text-center">
            <div class="col-md-12">
                <span><b>No results found. </b></span>
            </div>
        </div>
    {% endif %}

    <div class="clearfix"></div>


    <div id="batchTagging" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 450px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Batch Tagging [Author]</h4>
                </div>
                <div class="modal-body" style="overflow:hidden;">
                    <div class="row">
                        <div class="form-group col-md-12">

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-4">
                                    <label class="control-label" for="batch_input_code">Code:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <select class="form-control input-sm select2" id="batch_input_code" style="width: 230px;">
                                        <option value="">-- Select --</option>
                                        {% for author in authors %}
                                            <option value="{{ author.code }}">{{ author.code }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-4">
                                    <label class="control-label" for="batch_input_author">Author:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <select class="form-control input-sm select2" id="batch_input_author" style="width: 230px;">
                                        <option value="">-- Select --</option>
                                        {% for author in authors  %}
                                            <option value="{{ author.name }}">{{ author.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-4">
                                    <label class="control-label" for="batch_input_type">Class:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <select class="form-control input-sm" id="batch_input_type">
                                        <option value="">-- All --</option>
                                        <option value="COL">Columnist</option>
                                        <option value="CON">Contributor</option>
                                        <option value="COR">Correspondent</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div align="center">
                        <button type="button" class="btn btn-sm btn-info" id="batch_tagging_confirm">Confirm</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="postAP" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 450px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Post Triple C Transactions to AP</h4>
                </div>
                <div class="modal-body" style="overflow:hidden;">
                    <div class="row">
                        <div class="form-group col-md-12">

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-4">
                                    <label class="control-label" for="batch_input_code">AP Date:</label>
                                </div>
                                <div class="form-group col-md-8">
                                    <input type="text" class="form-control datepickerto" id="apdate" style="width:150px;" placeholder="AP Date">
                                </div>
                            </div>
                        </div>
                    </div>
                    <br><br>
                    <div class="well well-sm pre-scrollable" style="margin-bottom: 0px;min-height:400px;">
                        <table class="table table-sm" id="postingresult">
                            <thead>
                                <tr>
                                <!-- <th scope="row"><input type="checkbox" id="checkAll"></th> -->
                                <td scope="row"><b>CS No.</b></td>
                                <td scope="row"><b>Issue Date</b></td>
                                <td scope="row"><b>Class</b></td>
                                <td scope="row"><b>Author Name</b></td>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div align="center">
                        <button type="button" class="btn btn-sm btn-info" id="post_ap_confirm">Go</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Not working, too many to fix -->
    <!-- <div id="batchTransactionEntry" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 850px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Batch Transaction Entry</h4>
                </div>
                <div class="modal-body" style="overflow:auto;">
                    <div class="row">
                        <div class="form-group col-md-12">
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="batch_input_type">Issue Date:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input class="form-control input-sm" id="no_of_transaction" readonly />
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="batch_input_type">Code:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <select class="form-control input-sm" id="batch_input_type">
                                        <option value="">-- Select --</option>
                                        
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="batch_input_author">Author Name:</label>
                                </div>
                                <div class="form-group col-md-4">
                                    <select class="form-control input-sm" id="batch_input_author">
                                        <option value="">-- Select --</option>
                                        {% if authors %}
                                            {% for author in authors  %}
                                                <option value="{{ author.name }}">{{ author.name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="batch_input_author">Type:</label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input class="form-control input-sm" id="batch_input_author" />
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="batch_input_author">Section:</label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input class="form-control input-sm" id="batch_input_author" />
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div align="center">
                        <button type="button" class="btn btn-sm btn-info" id="batch_tagging_confirm">Confirm</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div> -->


    <div id="transactionEntryModal" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 990px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Transaction Entry #<span id="label_transaction_entry_number"></span></h4>
                </div>
                <div class="modal-body" style="overflow:auto;">
                    <div class="row">
                        <div class="form-group col-md-12">

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_issue_date">Issue Date: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-2">
                                    <!-- pk -->
                                    <input type="hidden" id="modal_pk" />
                                    <input type="hidden" id="modal_supplier_pk" />
                                    <input type="hidden" id="modal_status" />
                                    <input class="form-control input-sm required-field" id="input_issue_date" readonly />
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_code">Code: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-2">
                                    <select class="form-control input-sm required-field" id="select_code">
                                        {% if authors %}
                                            <option value="">-- Select --</option>
                                            {% for author in authors  %}
                                                <option value="{{ author.code }}">{{ author.code }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_author_name">Author Name: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-6">
                                    <select class="form-control input-sm required-field" id="select_author_name">
                                        <option value="">-- Select --</option>
                                        {% if authors %}
                                            {% for author in authors  %}
                                                <option value="{{ author.name }}" data-code="{{ author.code }}">{{ author.name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_type">Classification: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <select class="form-control input-sm required-field" id="select_type">
                                        <option value="">-- Select --</option>
                                        {% for classification in classifications %}
                                            <option value="{{ classification.code }}">{{ classification.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_subtype">Type: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <select class="form-control input-sm required-field" id="select_subtype">
                                        <option value="">-- Select --</option>
                                        {% for subtype in subtypes  %}
                                            <option value="{{ subtype.id }}" data-code="{{ subtype.code }}">{{ subtype.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_bureau">Bureau: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <select class="form-control input-sm required-field" id="select_bureau">
                                        <option value="">-- Select --</option>
                                        {% for bureau in bureaus  %}
                                            <option value="{{ bureau.id }}" data-code="{{ bureau.code }}">{{ bureau.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_section">Section: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <select class="form-control input-sm required-field" id="select_section">
                                        <option value="">-- Select --</option>
                                        {% for section in sections %}
                                            <option value="{{ section.id }}" data-code="{{ section.code }}">{{ section.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_article_title">Article Title: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-10">
                                    <input type="text" class="form-control input-sm required-field" id="input_article_title" />
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_no_of_ccc">No. of CCC: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm" id="input_no_of_ccc">
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_no_of_items">No. of Items: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm" id="input_no_of_items">
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_page">Page No.: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-2">
                                    <select class="form-control input-sm required-field" id="select_page">
                                        <option value="">-- Select --</option>
                                        {% for page in pages %}
                                            <option value="{{ page.description }}" data-id="{{ page.id }}">{{ page.description }}</option>
                                        {% endfor %}
                                    </select>
                                    <!-- <input type="text" class="form-control input-sm required-field" id="input_page_no" /> -->
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_no_of_words">No. of Words: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input type="number" class="form-control input-sm required-field" id="input_no_of_words">
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_no_of_characters">No. of Characters: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input type="number" class="form-control input-sm required-field" id="input_no_of_characters">
                                </div>
                            </div>
                            <br><br>
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_length1">Length1: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_length1">
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_width1">Width1: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_width1">
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_length2">Length2: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_length2">
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_width2">Width2: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_width2">
                                </div>
                            </div>

                            <br><br>
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_length3">Length3: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_length3">
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_width3">Width3: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_width3">
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_length4">Length4: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_length4">
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_width4">Width4: </label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="number" class="form-control input-sm size-field" id="input_width4">
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_total_size">Total Size: </label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input type="number" class="form-control input-sm" id="input_total_size" readonly>
                                </div>
                            </div>
                            
                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="select_rate_code">Rate Code: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <select class="form-control input-sm required-field" id="select_rate_code">
                                        <option value="">-- Select --</option>
                                        <option value="customizable" data-amount="">Customizable</option>
                                        {% for rate in rates %}
                                            <option value="{{ rate.code }}" data-amount="{{ rate.amount }}">{{ rate.code }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ rate.amount }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_amount">Amount: <span class="text-danger">*</span></label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input type="number" class="form-control input-sm required-field" id="input_amount">
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="form-group col-md-12">

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_confirmation">Confirmation:</label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input type="text" class="form-control input-sm" id="input_confirmation" readonly>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_date_printed">Date Printed:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control input-sm" id="input_date_printed" readonly>
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label">Status:</label>
                                </div>
                                <div class="col-md-4">
                                    <span id="status_txt"></span>
                                    <!-- <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="radio_status" id="radio_status_active" value="active">
                                        <label class="form-check-label" for="radio_status_active">Active</label>
                                        &nbsp;&nbsp;
                                        <input class="form-check-input" type="radio" name="radio_status" id="radio_status_posted" value="posted">
                                        <label class="form-check-label" for="radio_status_posted">Posted</label>
                                    </div> -->
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_date_posted">Date Posted:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control input-sm" id="input_date_posted" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <div class="row">
                        <div class="form-group col-md-12">

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_check_no">Check No.:</label>
                                </div>
                                <div class="form-group col-md-4">
                                    <input type="text" class="form-control input-sm" id="input_check_no" readonly>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_date_check">Date Check:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control input-sm" id="input_date_check" readonly>
                                </div>
                            </div>

                            <div class="form-group col-md-12 extra-field">
                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_apv_no">APV No.:</label>
                                </div>
                                <div class="form-group col-md-4">
                                    <div class="row">
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control input-sm" id="input_apv_no" readonly>
                                        </div>
                                        <div class="col-sm-4" id="apv_view_area">
                                            <a href="" id="view_apv" target="_blank" style="display: none;">View</a>
                                            <a href="#" id="trigger_view_apv" title="View APV">View</a>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-md-2">
                                    <label class="control-label" for="input_date_apv">Date APV:</label>
                                </div>
                                <div class="form-group col-md-2">
                                    <input type="text" class="form-control input-sm" id="input_date_apv" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div align="center">
                        <button type="button" class="btn btn-info" id="btn_save_transaction_entry" disabled="disabled">Save</button>
                        &nbsp;&nbsp;
                        <button type="button" class="btn btn-default" id="btn_cancel_transaction_entry" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>

{% block extra_js %}
    <script type="text/javascript">
    $(function(){
        $('.select2').select2({
            dropdownParent: $('#triplec_result')
        });
        $('#apdate').datepicker('setDate', 'now');
        // row numbering
        if($('#triplec_table > tbody > tr').length > 0){
            var t = 0;
            $('#triplec_table > tbody > tr').filter(':visible').each(function(){
                if(!$(this).hasClass('subtotal')){
                    t++;
                    $(this).find("td:nth-child(1)").text(t);
                }
            });
        }

        $('#full_screen').click(function(){
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                $('#triplec_result').get(0).requestFullscreen();
                $('#triplec_result').css({
                    background: '#fff'
                });
            }
        });

        // main checkbox change
        $(document).on('change', 'input[name="chb_all"]', function() {
            $('.triplec-checkbox').prop("checked", this.checked);

            if($('.triplec-checkbox:checked').length > 0){
                $('#batch_tagging').removeAttr('disabled');
                $('#batch_save').removeAttr('disabled');
                $('#batch_print').removeAttr('disabled');
                $('#batch_transaction_entry').removeAttr('disabled');
                $('#post_ap').removeAttr('disabled');
            } else {
                $("#batch_tagging").prop("disabled", true);
                $("#batch_save").prop("disabled", true);
                $("#batch_print").prop("disabled", true);
                $("#batch_transaction_entry").prop("disabled", true);
                $("#post_ap").prop("disabled", true);
            }
        });

        // single checkbox change
        $(document).on('change', '.triplec-checkbox', function() {
            if($('.triplec-checkbox:checked').length > 0){
                $('#batch_tagging').removeAttr('disabled');
                $('#batch_save').removeAttr('disabled');
                $('#batch_print').removeAttr('disabled');
                $('#batch_transaction_entry').removeAttr('disabled');
                $('#post_ap').removeAttr('disabled');
            } else {
                $("#batch_tagging").prop("disabled", true);
                $("#batch_save").prop("disabled", true);
                $("#batch_print").prop("disabled", true);
                $("#batch_transaction_entry").prop("disabled", true);
                $("#post_ap").prop("disabled", true);
            }

            if($('.triplec-checkbox').length === $('.triplec-checkbox:checked').length){
                $('input[name="chb_all"]').prop("checked", true);
            } else if (this.checked == false) {
                $('input[name="chb_all"]').prop("checked", false);
            }
        });

        // in batch tagging modal - code
        $('#batch_input_code').change(function(){

            const row = $(this).closest('tr');
            const code = $(this).val();

            if(code != ''){
                $.ajax({
                    url: "{% url 'triplec:get_supplier_by_code' %}"+"?code="+code,
                    type: "get",
                    data: {
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true){

                            $('#batch_input_author').val(response.supplier[0].name).change();
                            $('#batch_input_type').val(response.supplier[0].ccc).change();
                            
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            } else {
                row.find('.edit-transaction-entry').toggleClass('hidden');
                row.find("select[name=author_name]").val('').change();
                row.find("select[name=type]").val('').change();
            }

        });

        // batch tagging
        $('#batch_tagging_confirm').click(function(){
            const code = $('#batch_input_code').val();
            const author = $('#batch_input_author').val();
            const type = $('#batch_input_type').val();
            if(code != ''){
                if(confirm('Confirm batch tagging?')){
                    $('#triplec_table > tbody > tr').filter(':visible').each(function(){
                        if($(this).find(".triplec-checkbox").is(":checked")){

                            $(this).find('.edit-transaction-entry').removeClass('hidden');
                            $(this).find("select[name=code]").val(code).change();
                            $(this).find("select[name=author_name]").val(author).change();
                            $(this).find("select[name=type]").val(type).change();
                            
                        }
                    });
                }
            } else {
                alert('Please select Code');
            }
            $('#batchTagging').modal('toggle');
        });

        // batch saving
        $('#batch_save').click(function(){
            if(confirm('Confirm saving the selected rows? Note: unselected rows will not be saved.')){
                for_saving = [];
                $('#triplec_table > tbody > tr').filter(':visible').each(function(){
                    if($(this).find(".triplec-checkbox").is(":checked")){

                        var id = $(this).find("input[name=data_id]").val();
                        var code = $(this).find("select[name=code]").val();
                        var author = $(this).find("select[name=author_name]").val();
                        var type = $(this).find("select[name=type]").val();

                        if(id != '' && type != '' && author != '') {
                            for_saving.push({
                                id: id,
                                code: code,
                                author: author,
                                type: type
                            });
                        }
                    }
                });
                if($.isEmptyObject(for_saving)){
                    alert("There's no data to save!");
                } else {
                    
                    $.ajax({
                        url: "{% url 'triplec:save_batch_tagging' %}",
                        type: "post",
                        data: {
                            'csrfmiddlewaretoken': "{{ csrf_token }}",
                            'data': JSON.stringify(for_saving)
                        },
                        success: function(response) {
                            if(response.result == 'success'){
                                alert("Save successful");
                            } else {
                                alert("Error saving data");
                            }
                        },
                        error: function(response) {
                            alert("Error saving data");
                        }
                    });
                }
            }
        });

        // batch print
        $('#batch_print').click(function(){
            for_printing = [];
            $('#triplec_table > tbody > tr').filter(':visible').each(function(){
                if($(this).find(".triplec-checkbox").is(":checked")){

                    var confirmation = $(this).find("input[name=data_confirmation]").val();
                    var status = $(this).find("input[name=data_status]").val();
                    
                    if(confirmation != '' && status == 'O') {
                        for_printing.push(confirmation);
                    }

                }
            });
            if($.isEmptyObject(for_printing)){
                alert("There's no posted transaction to print");
            } else {
                var unique_cs_list = [...new Set(for_printing)];
                $("#trigger_cs").attr("href", "{% url 'triplec:print_cs' %}" + "?batch=1&q=" + encodeURIComponent(JSON.stringify(unique_cs_list)));
                $('#trigger_cs')[0].click();
                
            }
        });

        // Transaction entry modal
        $('.edit-transaction-entry').click(function(){

            resetTransactionEntryModal();

            const row = $(this).closest('tr');
            
            var pk = row.find("input[name=data_id]").val();
            var status = row.find("input[name=data_status]").val();
            var status_txt = row.find("input[name=data_status_txt]").val();
            var row_num = row.find('.c0').text();
            var issue_date = row.find('.c2').text();
            var section = row.find('.c4').text().toUpperCase();
            var page_no = row.find('.c5').text();
            var article_title = row.find('.c6').text();
            var no_of_words = row.find('.c12').text();
            var no_of_characters = row.find('.c13').text();
            var bureau = row.find('.c14').text();
            var subtype = row.find('.c15').text();
            var subtype_id = row.find("input[name=data_subtype_id]").val();
            var bureau_id = row.find("input[name=data_bureau_id]").val();
            var section_id = row.find("input[name=data_section_id]").val();

            var rate_code = row.find("input[name=data_rate_code]").val();
            var amount = row.find("input[name=data_amount]").val();
            var no_of_ccc = row.find("input[name=data_no_of_ccc]").val();
            var no_of_items = row.find("input[name=data_no_of_items]").val();
            var length1 = row.find("input[name=data_length1]").val();
            var length2 = row.find("input[name=data_length2]").val();
            var length3 = row.find("input[name=data_length3]").val();
            var length4 = row.find("input[name=data_length4]").val();
            var width1 = row.find("input[name=data_width1]").val();
            var width2 = row.find("input[name=data_width2]").val();
            var width3 = row.find("input[name=data_width3]").val();
            var width4 = row.find("input[name=data_width4]").val();
            var total_size = row.find("input[name=data_total_size]").val();
            var confirmation = row.find("input[name=data_confirmation]").val();
            var apv_no = row.find("input[name=data_apv_no]").val();
            var apv_date = row.find("input[name=data_apv_date]").val();
            var type = row.find("select[name=type]").val();
            var author_name = row.find("select[name=author_name]").val();

            $('#label_transaction_entry_number').text(row_num);
            $('#input_issue_date').val(issue_date);
            
            $('#input_article_title').val(article_title);
            $('#select_page').val(page_no).change();
            $('#input_no_of_words').val(no_of_words);
            $('#input_no_of_characters').val(no_of_characters);
            $('#select_rate_code').val(rate_code).change();
            $('#input_amount').val(amount);
            $('#input_no_of_ccc').val(no_of_ccc);
            $('#input_no_of_items').val(no_of_items);
            $('#input_length1').val(length1);
            $('#input_length2').val(length2);
            $('#input_length3').val(length3);
            $('#input_length4').val(length4);
            $('#input_width1').val(width1);
            $('#input_width2').val(width2);
            $('#input_width3').val(width3);
            $('#input_width4').val(width4);
            $('#input_total_size').val(total_size);

            $('#status_txt').text(status_txt);
            $('#modal_status').val(status);

            $('#modal_pk').val(pk);
            if(confirmation !== 'None' || confirmation !== ''){
                $('#input_confirmation').val(confirmation);
                if(apv_no !== 'None'){
                    $('#apv_view_area').show();
                    $('#input_apv_no').val(apv_no);
                    $('#input_date_apv').val(apv_date);
                } else {
                    $('#apv_view_area').hide();
                }
            }

            if(type != ''){
                $('#select_type').val(type).change();

                var is_disabled = type === 'COR' ? false : true;
                size_fields(is_disabled);
            }

            $('#select_subtype').val(subtype_id).change();
            $('#select_bureau').val(bureau_id).change();
            $('#select_section').val(section_id).change();

            $('#select_author_name').val(author_name).change();
            if(author_name != ''){
                var code = $('#select_author_name option:selected').attr('data-code');
                $('#select_code').val(code).change();

                if (status_txt === 'Active') {
                    supplier_suggestion(code);
                }
            }

        });

        function supplier_suggestion(code){
            $.ajax({
                url: "{% url 'triplec:supplier_suggestion' %}"+"?code="+code,
                type: "get",
                data: {
                    'csrfmiddlewaretoken': "{{ csrf_token }}",
                },
                success: function(response) {
                    if (response.result === true){
                        $('#select_bureau').val(response.triplecsupplier[0].bureau).change();
                        $('#select_section').val(response.triplecsupplier[0].section).change();
                    } else {
                        alert(response.message);
                    }
                },
                error: function(response) {
                    alert('Connection error.');
                }
            });
            
        }

        // revert transaction status as Ready for Posting
        $('.revert-transaction-entry').click(function(){
            var id = $(this).closest('tr').find("input[name=data_id]").val();
            var csno = $(this).closest('tr').find("input[name=data_confirmation]").val();
            
            if(csno != '' && id != ''){
                $.ajax({
                    url: "{% url 'triplec:count_csno' %}",
                    type: "post",
                    data: {
                        'csno': csno,
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true){

                            var count_csnum = response.count;
                            var confirm_message = '';
                            if (count_csnum > 1){
                                confirm_message = 'Warning: The CS No. of this transaction have '+ count_csnum +' related transactions. Are you sure to proceed? Reverting will recompute the NET amount.';
                            } else {
                                confirm_message = 'Are you sure to revert transaction status? Associated data like quota and CS No. will be removed.';
                            }

                            if(confirm(confirm_message)){
                                
                                revert_transaction(id);
                            } 
                        } else {
                            custom_failed_alert(response.message);
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            } else {
                alert('Request is empty.');
            }
            
            return false;
        });

        $('#trigger_view_apv').click(function(){
            var apnum = $('#input_apv_no').val();

            if(apnum != ''){
                $.ajax({
                    url: "{% url 'triplec:get_ap_id' %}",
                    type: "post",
                    data:{
                        'apnum': apnum,
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true && response.ap_id){
                            var detailUrl = "{% url 'accountspayable:detail' 0 %}".replace('0', response.ap_id);
                            $("#view_apv").attr("href", detailUrl);
                            $('#view_apv')[0].click();
                        } else {
                            custom_failed_alert("APV unavailable.");
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            }
        });

        function revert_transaction(id){
            if(id != ''){
                $.ajax({
                    url: "{% url 'triplec:revert_transaction' %}",
                    type: "post",
                    data: {
                        'id': id,
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true){
                            custom_success_alert(response.message);
                        } else {
                            custom_failed_alert(response.message);
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            } else {
                alert('Request id is empty.');
            }
        }

        $('#select_type').change(function(){
            var type = $(this).val();
            $("#select_type option[value='"+ type +"']").attr("selected");

            var is_disabled = type === 'COR' ? false : true;
            size_fields(is_disabled);
        });

        function size_fields(is_disabled){
            if(is_disabled){
                $('.size-field').attr('disabled', 'disabled');
            } else {
                $('.size-field').removeAttr('disabled');
            }
        }

        // In modal - rate code 
        $('#select_rate_code').change(function(){
            var rate = $('#select_rate_code option:selected').attr('data-amount');
            if(rate == ''){
                $('#input_amount').val('').focus();
            } else {
                if($('#input_total_size').val() > 1 || $('#input_no_of_ccc') > 1){
                    size_and_amount_computation();
                } else {
                    $('#input_amount').val(rate);
                }
            }

        });

        // in table row - code
        $('select[name=code]').change(function(){

            const row = $(this).closest('tr');
            const code = $(this).val();

            if(code != ''){
                $.ajax({
                    url: "{% url 'triplec:get_supplier_by_code' %}"+"?code="+code,
                    type: "get",
                    data: {
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true){
                            row.find('.edit-transaction-entry').removeClass('hidden');
                            row.find("select[name=author_name]").val(response.supplier[0].name).change();
                            row.find("select[name=type]").val(response.supplier[0].ccc).change();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            } else {
                row.find('.edit-transaction-entry').toggleClass('hidden');
                row.find("select[name=author_name]").val('').change();
                row.find("select[name=type]").val('').change();
            }
           
        });

        // in transaction entry modal
        $('#select_code').change(function(){

            const code = $(this).val();

            if(code != ''){
                $.ajax({
                    url: "{% url 'triplec:get_supplier_by_code' %}"+"?code="+code,
                    type: "get",
                    data: {
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true){
                            $("#select_author_name").val(response.supplier[0].name).change();
                            // $("#select_type").val(response.supplier[0].ccc).change();
                            $("#select_type option[value='"+ response.supplier[0].ccc +"']").attr("selected");
                            $('#modal_supplier_pk').val(response.supplier[0].id);
                            
                            var status = $('#status_txt').text() || '';
                            if (status === 'Active') supplier_suggestion(code);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            } else {
                $("#select_author_name").val('').change();
                $("#select_type").val('').change();
            }

        });

        // in table row - code
        $('select[name=code]').change(function(){

            const row = $(this).closest('tr');
            const code = $(this).val();

            if(code != ''){
                $.ajax({
                    url: "{% url 'triplec:get_supplier_by_code' %}"+"?code="+code,
                    type: "get",
                    data: {
                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                    },
                    success: function(response) {
                        if (response.result === true){
                            row.find('.edit-transaction-entry').removeClass('hidden');
                            row.find("select[name=author_name]").val(response.supplier[0].name).change();
                            row.find("select[name=type]").val(response.supplier[0].ccc).change();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(response) {
                        alert('Connection error.');
                    }
                });
            } else {
                row.find('.edit-transaction-entry').toggleClass('hidden');
                row.find("select[name=author_name]").val('').change();
                row.find("select[name=type]").val('').change();
            }
           
        });

        // in table row - author name
        // $('select[name=author_name]').change(function(){
        //     const row = $(this).closest('tr');
        //     const name = $(this).val();
        //     if(name != ''){
        //         $.ajax({
        //             url: "{% url 'triplec:get_supplier_by_name' %}"+"?name="+name,
        //             type: "get",
        //             data: {
        //                 'csrfmiddlewaretoken': "{{csrf_token}}",
        //             },
        //             success: function(response) {
        //                 if (response.result === true){
        //                     row.find('.edit-transaction-entry').removeClass('hidden');
        //                     row.find("select[name=code]").val(response.supplier[0].code).change();
        //                     row.find("select[name=type]").val(response.supplier[0].ccc).change();
                            
        //                 } else {
        //                     alert(response.message);
        //                 }
        //             },
        //             error: function(response) {
        //                 alert('Connection error.');
        //             }
        //         });
        //     } else {
        //         row.find('a.edit-transaction-entry').toggleClass('hidden');
        //         row.find("select[name=code]").val('').change();
        //         row.find("select[name=type]").val('').change();
        //     }
        //     return false;
        // });

        // cancel modal
        $('#btn_cancel_transaction_entry').click(function(){
            resetTransactionEntryModal();
        });

        // reset modal fields
        function resetTransactionEntryModal(){
            
            $('#label_transaction_entry_number').text('');
            $('#input_issue_date').val('');
            $('#select_section').val('').change();
            $('#input_article_title').val('');
            $('#select_page').val('').change();
            $('#input_no_of_words').val('');
            $('#input_no_of_characters').val('');
            $('#select_rate_code').val('').change();
            $('#input_amount').val('');
            $('#select_type').val('').change();
            $('#select_code').val('').change();
            $('#select_author_name').val('').change();
            $('#select_subtype').val('').change();
            $('#select_bureau').val('').change();
            $('#input_confirmation').val('');
            $('#input_no_of_ccc').val('');
            $('#input_no_of_items').val('');
            $('#input_length1').val('');
            $('#input_length2').val('');
            $('#input_length3').val('');
            $('#input_length4').val('');
            $('#input_width1').val('');
            $('#input_width2').val('');
            $('#input_width3').val('');
            $('#input_width4').val('');
            $('#input_total_size').val('');
            $('#status_txt').text('');
            // $('input[name=radio_status]').attr('checked', false);

            return true;
        }

        // Save Transction Entry
        $('#btn_save_transaction_entry').click(function(){
            var fields_arr = [];
            fields_arr['pk'] = [$('#modal_pk').val()];
            fields_arr['supplier_pk'] = [$('#modal_supplier_pk').val()];
            fields_arr['status'] = [$('#modal_status').val()];
            fields_arr['issue_date'] = [$('#input_issue_date').val(), 'Issue Date'];
            fields_arr['code'] = [$('#select_code').val(), 'Code'];
            fields_arr['author_name'] = [$('#select_author_name').val(), 'Author Name'];
            fields_arr['type'] = [$('#select_type').val(), 'Classification'];
            fields_arr['subtype'] = [$('#select_subtype').val(), 'Type'];
            fields_arr['bureau'] = [$('#select_bureau').val(), 'Bureau'];
            fields_arr['section'] = [$('#select_section').val(), 'Section'];
            fields_arr['article_title'] = [$('#input_article_title').val(), 'Article Title'];
            fields_arr['no_of_ccc'] = [$('#input_no_of_ccc').val()];
            fields_arr['no_of_items'] = [$('#input_no_of_items').val()];
            fields_arr['page_no'] = [$('#select_page option:selected').attr('data-id'), 'Page No.'];
            fields_arr['no_of_words'] = [$('#input_no_of_words').val(), 'No. of Words'];
            fields_arr['no_of_characters'] = [$('#input_no_of_characters').val(), 'No. of Characters'];
            fields_arr['length1'] = [$('#input_length1').val()];
            fields_arr['length2'] = [$('#input_length2').val()];
            fields_arr['length3'] = [$('#input_length3').val()];
            fields_arr['length4'] = [$('#input_length4').val()];
            fields_arr['width1'] = [$('#input_width1').val()];
            fields_arr['width2'] = [$('#input_width2').val()];
            fields_arr['width3'] = [$('#input_width3').val()];
            fields_arr['width4'] = [$('#input_width4').val()];
            fields_arr['total_size'] = [$('#input_total_size').val()];
            fields_arr['rate_code'] = [$('#select_rate_code').val(), 'Rate Code'];
            fields_arr['amount'] = [$('#input_amount').val(), 'Amount'];
            // fields_arr['confirmation'] = [$('#input_confirmation').val(), 'Confirmation'];
            
            is_success = true;
            for (var field in fields_arr){

                const field_name = fields_arr[field][0];
                const field_desc = fields_arr[field][1];
                
                if(field_desc != undefined && field_name == ''){
                    alert(field_desc + " field is required.");
                    is_success = false;
                }
            }

            if(!is_success){
                return false; // terminate

            } else {
                proceed = true;

                if((fields_arr['status'][0] == 'O') && (!confirm('This is already a posted transaction. Are you sure to override data?'))){
                    proceed = false;
                }
                if(proceed){
                    $.ajax({
                        url: "{% url 'triplec:save_transaction_entry' %}",
                        type: "post",
                        data: {
                            'csrfmiddlewaretoken': "{{csrf_token}}",
                            'id': fields_arr['pk'][0],
                            'supplier_id': fields_arr['supplier_pk'][0],
                            'issue_date': fields_arr['issue_date'][0],
                            'code': fields_arr['code'][0],
                            'author_name': fields_arr['author_name'][0],
                            'type': fields_arr['type'][0],
                            'subtype': fields_arr['subtype'][0],
                            'bureau': fields_arr['bureau'][0],
                            'section': fields_arr['section'][0],
                            'article_title': fields_arr['article_title'][0],
                            'no_of_ccc': fields_arr['no_of_ccc'][0] || 0,
                            'no_of_items': fields_arr['no_of_items'][0] || 0,
                            'page_no': fields_arr['page_no'][0],
                            'no_of_words': fields_arr['no_of_words'][0],
                            'no_of_characters': fields_arr['no_of_characters'][0],
                            'length1': fields_arr['length1'][0] || 0,
                            'length2': fields_arr['length2'][0] || 0,
                            'length3': fields_arr['length3'][0] || 0,
                            'length4': fields_arr['length4'][0] || 0,
                            'width1': fields_arr['width1'][0] || 0,
                            'width2': fields_arr['width2'][0] || 0,
                            'width3': fields_arr['width3'][0] || 0,
                            'width4': fields_arr['width4'][0] || 0,
                            'total_size': fields_arr['total_size'][0] || 0,
                            'rate_code': fields_arr['rate_code'][0],
                            'amount': fields_arr['amount'][0],
                        },
                        success: function(response) {

                            if (response.result === true){

                                alert('Transaction saved successfully');
                                $('#retrieve').trigger('click');
                            } else {
                                alert(response.message);
                            }
                            $('#transactionEntryModal').modal('hide');
                        },
                        error: function(response) {
                            alert('Connection error.');
                            $('#transactionEntryModal').modal('hide');
                        }
                    });
                }
                return false;
            }
        });

        // Disable save button if inputs are empty
        $('.required-field').on('input change propertychange', function() {
            
            var empty = false;
            $('.required-field').each(function() {
                if ($(this).val().length == 0) {
                    empty = true;
                    return false;
                }
            });

            if (empty) {
                $('#btn_save_transaction_entry').attr('disabled', 'disabled');
            } else {
                $('#btn_save_transaction_entry').removeAttr('disabled');
            }
        });

        // Post to AP (first)
        $('#post_ap').click(function(){
            $("#postingresult > tbody").html("");
            var for_posting = [];
            $('#triplec_table > tbody > tr').filter(':visible').each(function(){
                if($(this).find(".triplec-checkbox").is(":checked")){

                    var id = $(this).find("input[name=data_id]").val();
                    var status = $(this).find("input[name=data_status]").val();
                    var cs = $(this).find("input[name=data_confirmation]").val();
                    var issue_date = $(this).find(".c2").text();
                    var author = $(this).find("select[name=author_name]").val();
                    var type = $(this).find("select[name=type]").val();

                    if(id != '' && status == 'O') {
                        if (for_posting.length === 0 || for_posting.find(e => e.cs != cs)) {

                            var newRowContent = "<tr>\
                                    <td>"+cs+"</td>\
                                    <td>"+issue_date+"</td>\
                                    <td>"+type+"</td>\
                                    <td>"+author+"</td>\
                                </tr>";
                            $("#postingresult > tbody").append(newRowContent);
                            
                            for_posting.push({
                                cs: cs, 
                                issue_date: issue_date, 
                                author: author, 
                                type: type
                            });
                        }
                    }
                }
            });
            
            console.log(for_posting);
        });

        // AP posting
        $('#post_ap_confirm').click(function(){
            
            var for_posting = [];
            $('#triplec_table > tbody > tr').filter(':visible').each(function(){
                if($(this).find(".triplec-checkbox").is(":checked")){

                    var id = $(this).find("input[name=data_id]").val();
                    var status = $(this).find("input[name=data_status]").val();
                    
                    if(id != '' && status == 'O') {
                        for_posting.push(id);
                    }
                }
            });
            var post_length = for_posting.length;
            var postdate = $('#apdate').val();
            if(post_length === 0 || postdate === ''){
                alert("There's no posted transaction to post");
                return false;

            } else {
                var transaction_text = post_length > 1 ? 'transactions' : 'transaction';
                if(confirm('Are you sure to post '+post_length+' '+transaction_text+ ' to AP?')){

                    $.ajax({
                        url: "{% url 'triplec:goposttriplec' %}",
                        type: "post",
                        data: {
                            'csrfmiddlewaretoken': "{{ csrf_token }}",
                            'ids': for_posting,
                            'postdate': postdate,
                        },
                        success: function(response){
                            if(response.status === 'success'){
                                alert('Posting to AP of '+post_length+' '+transaction_text+' has been successful!');
                            } else {
                                alert(response.message);
                            }
                        }, error: function(response) {
                            alert('Posting to AP of '+post_length+' '+transaction_text+' failed.');
                            console.debug(response);
                        }
                    });
                }
            }
        });

        $("#input_no_of_ccc, #input_length1, #input_width1, #input_length2, #input_width2, #input_length3, #input_width3, #input_length4, #input_width4").on('change paste keyup input', function(){
            size_and_amount_computation();
        });

        function size_and_amount_computation(){

            const total_size1 = size1() || 0;
            const total_size2 = size2() || 0;
            const total_size3 = size3() || 0;
            const total_size4 = size4() || 0;
            const no_of_ccc = ccc_num() || 0;

            const new_total_size = total_size1 + total_size2 + total_size3 + total_size4;
            
            const rate = parseFloat($('#select_rate_code option:selected').attr('data-amount')) || 0;
            if (rate > 0){

                var new_amount = 0;
                if(new_total_size > 0){
                    new_amount = new_total_size * rate;
                } else {
                    new_amount = rate;
                }

                if(no_of_ccc > 1){
                    const divided_amount = new_amount / no_of_ccc;
                    $('#input_amount').val(divided_amount.toFixed(2));
                } else {
                    $('#input_amount').val(new_amount.toFixed(2));
                }
            }
            $('#input_total_size').val(new_total_size.toFixed(2));
        }

        function size1(){
            var size = 0;
            var length = parseFloat($('#input_length1').val()) || 0;
            var width = parseFloat($('#input_width1').val()) || 0;

            if(length > 0 && width > 0){
                size = length * width;
            } 
            return size;
        }

        function size2(){
            var size2 = 0;
            var length2 = parseFloat($('#input_length2').val()) || 0;
            var width2 = parseFloat($('#input_width2').val()) || 0;

            if(length2 > 0 && width2 > 0){
                size2 = length2 * width2;
            } 
            return size2;
        }

        function size3(){
            var size = 0;
            var length = parseFloat($('#input_length3').val()) || 0;
            var width = parseFloat($('#input_width3').val()) || 0;

            if(length > 0 && width > 0){
                size = length * width;
            } 
            return size;
        }

        function size4(){
            var size = 0;
            var length = parseFloat($('#input_length4').val()) || 0;
            var width = parseFloat($('#input_width4').val()) || 0;

            if(length > 0 && width > 0){
                size = length * width;
            } 
            return size;
        }

        function ccc_num(){
            var num = parseInt($('#input_no_of_ccc').val()) || 0;

            return num;
        }

        // custom alert messages
        function custom_success_alert(message){
            $('#custom-success-alert').text(message);
            customAlert($('#custom-success-alert'));
        }

        function custom_failed_alert(message){
            $('#custom-failed-alert').text(message);
            customAlert($('#custom-failed-alert'));
        }
    });

</script>
{% endblock extra_js %}
